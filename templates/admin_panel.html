{% extends "base_layout.html" %}

{% block head %}
{{ super() }}
<meta charset="UTF-8">
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/admin_panel.css') }}">
{% endblock %}

{% block title %}Admin Panel{% endblock %}

{% block list %}
{{super()}}
<li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
<li><a href="{{ url_for('admin_panel') }}">Admin Panel</a></li>
<li><a href="{{ url_for('profile') }}">Profile</a></li>
<li>
  <a href="{{url_for('logout')}}"><button class="button-signup custom-button">LogOut</button></a>
</li>
{% endblock %}

{% block content %}
<div class="custom-container admin-container">
  <h1>Admin Panel</h1>
  {% if request.args.get('message') %}
  <p class="flash-message">{{ request.args.get('message') }}</p>
  {% endif %}

  {# --- Admin Actions (inchangé) --- #}
  <div class="admin-actions">
    <form action="{{ url_for('backup_db') }}" method="POST">
      <button type="submit" class="custom-button">Backup Database</button>
    </form>
    <form method="POST" action="{{ url_for('kill_admins') }}"
      onsubmit="return confirm('Are you sure you want to reset the level of users with level >= 20, except yourself?');">
      <button type="submit" class="custom-button">Revoke Admin Rights</button>
    </form>
  </div>

  {# --- Users List (inchangé) --- #}
  <h2>Users List</h2>
  <div class="admin-table-container">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Username</th>
          <th>Email</th>
          <th>Role</th>
          <th>Is Admin</th>
          <th>Is Verified</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for user in users %}
        <tr>
          <td>{{ user.username }}</td>
          <td>{{ user.email }}</td>
          <td>{{ user.role }}</td>
          <td>
            {% if user.level >= 20 %}
            <span style="color: green; font-weight: bold;">Yes</span>
            {% else %}
            <span style="color: grey;">No</span>
            {% endif %}
          </td>
          <td>
            {% if user.is_verified %}
            <span style="color: green;">Yes</span>
            {% else %}
            <span style="color: orange;">No</span>
            {% endif %}
          </td>
          <td>
            {% if not user.is_verified %}
            <form action="{{ url_for('verify_user', user_id=user.id) }}" method="POST" style="display: inline-block;">
              <button type="submit" class="custom-button">Verify</button>
            </form>
            {% endif %}
            <form action="{{ url_for('delete_user', user_id=user.id) }}" method="POST"
              onsubmit="return confirm('Are you sure you want to delete user \'{{ user.username }}\'?');"
              style="display: inline-block;">
              <button type="submit" class="custom-button">Delete</button>
            </form>
            <a href="{{ url_for('edit_user', user_id=user.id) }}">
              <button class="custom-button">Modify</button>
            </a>
            <a href="{{ url_for('view_login_history', user_id=user.id) }}">
              <button class="custom-button">History</button>
            </a>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" style="text-align: center; padding: 20px; color: #777;">No users found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  {# --- Deletion Suggestions (SIMPLIFIÉ) --- #}
  <h2>Room Deletion Suggestions</h2>
  {# On utilise la variable passée par la route : room_suggestions #}
  {% if room_suggestions %}
  <div class="admin-table-container">
    <table class="admin-table">
      <thead>
        <tr>
          <th>Room Name</th>
          <th>Room ID</th>
          <th>Suggested By</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {# On itère sur la liste d'objets DelSuggestion #}
        {% for suggestion in room_suggestions %}
        <tr>
          <td>{{ suggestion.room_name }}</td> {# Accès direct à l'attribut #}
          <td>{{ suggestion.room_id }}</td> {# Accès direct à l'attribut #}
          <td>{{ suggestion.username }}</td> {# Accès direct à l'attribut #}
          <td>
            {# Formulaire pour Approuver la suppression #}
            {# L'action pointe vers une NOUVELLE route qu'il faudra créer #}
            <form action="{{ url_for('approve_room_deletion', suggestion_id=suggestion.id) }}" method="POST"
              style="display: inline-block;"
              onsubmit="return confirm('Approve deletion of room \'{{ suggestion.room_name }}\' (ID: {{ suggestion.room_id }})? This will delete the room and the suggestion.');">
              {# On passe l'ID de la pièce à supprimer en caché #}
              <input type="hidden" name="room_id_to_delete" value="{{ suggestion.room_id }}">
              <button type="submit" class="custom-button approve-button">Approve</button> {# Classe CSS optionnelle #}
            </form>

            {# Formulaire pour Rejeter la suggestion #}
            {# L'action pointe vers une NOUVELLE route qu'il faudra créer #}
            <form action="{{ url_for('reject_room_deletion', suggestion_id=suggestion.id) }}" method="POST"
              style="display: inline-block;"
              onsubmit="return confirm('Reject suggestion to delete room \'{{ suggestion.room_name }}\'? This will only remove the suggestion.');">
              <button type="submit" class="custom-button reject-button">Reject</button> {# Classe CSS optionnelle #}
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% else %}
  <p class="no-suggestions">No room deletion suggestions at the moment.</p>
  {% endif %}

  <br>
  <a href="{{ url_for('dashboard') }}" class="back-link" id="back-to-dashboard">← Back to Dashboard</a>

</div><!-- End admin-container -->
{% endblock %}


{% block foot %}
  <li><a href="{{ url_for('dashboard') }}">Dashboard</a></li>
  <li><a href="{{ url_for('admin_panel') }}">Admin Panel</a></li>
  <li><a href="{{ url_for('profile') }}">Profile</a></li>
{%endblock%}
